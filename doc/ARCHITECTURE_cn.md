# Go Doc Lint 架构设计指南

[English](ARCHITECTURE.md) | 中文版

## 概述

本文档解释了 go-doc-lint 的架构设计，包括为什么存在两个实现、它们的设计差异，以及如何协同工作。

---

## 目录

1. [设计哲学](#设计哲学)
2. [为什么需要两个实现](#为什么需要两个实现)
3. [架构对比](#架构对比)
4. [核心算法](#核心算法)
5. [实现差异](#实现差异)
6. [测试策略](#测试策略)
7. [性能考量](#性能考量)
8. [扩展工具](#扩展工具)

---

## 设计哲学

go-doc-lint 基于以下核心原则构建：

1. **跨平台支持**：在 Windows、Linux、macOS 和 WSL 上无缝工作
2. **无外部依赖**：仅使用原生语言特性（Bash 4.0+、PowerShell 5.0+、Perl）
3. **功能一致**：两个实现提供相同的功能
4. **代码清晰**：优先考虑可读性和可维护性而非优化
5. **完整测试**：每个实现都有 28 个测试覆盖所有代码路径

---

## 为什么需要两个实现

### 不同平台，不同工具

**Windows**：PowerShell 是原生 shell 且是 Windows 用户的首选

- PowerShell 5.0+ 包含在 Windows 10+ 中
- 与 Windows API 集成度更高
- Windows 用户偏好 PowerShell

**类 Unix 系统**：Bash 是标准 shell

- 在 Linux、macOS 和 WSL 中都可用
- 可在不同 Unix 发行版中移植
- 用户期望命令行工具使用 Bash

### 这种方式的优势

| 优势         | 解释                       |
| ------------ | -------------------------- |
| **原生体验** | 用户使用偏好的 shell       |
| **简便安装** | 无需额外的运行时           |
| **社区规范** | 遵循各平台的约定           |
| **平台特性** | 利用平台特定的功能         |
| **用户舒适** | 开发者使用熟悉的语法和模式 |

### 权衡

| 权衡         | 影响                                  |
| ------------ | ------------------------------------- |
| **代码重复** | 需要维护两个代码库                    |
| **双倍测试** | 共 56 个测试（每个实现 28 个）        |
| **学习曲线** | 贡献者需要同时了解 Bash 和 PowerShell |
| **维护工作** | 功能需要实现两次                      |

---

## 架构对比

### 高层结构

```text
┌─────────────────────────────────────────┐
│         用户输入（CLI 参数）             │
└──────────────┬──────────────────────────┘
               │
        ┌──────┴──────┐
        │             │
        ▼             ▼
   go-doc-lint.sh  go-doc-lint.ps1
   (Bash 4.0+)     (PowerShell 5.0+)
        │             │
        └──────┬──────┘
               │
        ┌──────▼──────────┐
        │   参数解析器     │
        └──────┬──────────┘
               │
        ┌──────▼──────────┐
        │   路径验证器     │
        └──────┬──────────┘
               │
        ┌──────▼──────────┐
        │    文件扫描器    │
        └──────┬──────────┘
               │
        ┌──────▼──────────┐
        │   注释解析器     │
        │ （状态机）      │
        └──────┬──────────┘
               │
        ┌──────▼──────────┐
        │  报告格式化器   │
        └──────┬──────────┘
               │
        ┌──────▼──────────┐
        │   输出处理器     │
        │(屏幕/文件)      │
        └──────────────────┘
```

### 模块分解

#### 1. 参数解析

**Bash 实现**：

- 手动参数解析，使用 `getopts` 和 case 语句
- 验证互斥性（例如 `--test` 和 `--all`）
- 使用数组存储解析值
- ~80 行解析逻辑

**PowerShell 实现**：

- 使用 `[CmdletBinding()]` 和 `[Parameter()]` 属性
- 原生参数验证
- 类型安全的参数处理
- 更清晰的关注点分离
- ~50 行参数定义

#### 2. 路径处理

**Bash 实现**：

- 使用 `cd` 和 `pwd` 进行路径规范化
- 用 `dirname` 进行相对路径解析
- 包含空格的路径转义处理
- 外部工具：`find`、`xargs`

**PowerShell 实现**：

- 用 `Resolve-Path` 转换为绝对路径
- 原生路径验证
- 原生通配符扩展
- 更清晰的路径对象模型

#### 3. 文件扫描

**Bash 实现**：

```bash
find "$input_path" -name "*.go" -type f | \
  grep -v vendor | grep -v '.git'
```

- 管道命令链
- 排除 vendor 和 .git 目录
- 递归过滤

**PowerShell 实现**：

```powershell
Get-ChildItem -Path $input_path -Filter "*.go" `
  -Recurse -File | Where-Object {
    $_.FullName -notmatch '(vendor|\.git)'
  }
```

- 对象管道
- 过滤排除逻辑
- 原生过滤

#### 4. 注释解析（状态机）

两个实现都使用相同的状态机算法来解析 Go 文档注释。

**状态机逻辑**：

```text
状态：
  NORMAL     - 注释块外
  IN_COMMENT - 注释块内
  IN_FUNC    - 找到函数/方法声明

规则：
1. 开始：NORMAL
2. // 注释 → 进入 IN_COMMENT
3. IN_COMMENT 中的空行 → 存储注释，返回 NORMAL
4. 另一个 // → 保持 IN_COMMENT，追加行
5. func 关键字 → IN_FUNC（在 IN_COMMENT 之后）
6. 提取：函数名、注释文本、完整声明
7. 对比：注释首词 vs 函数名
8. 记录：匹配或不匹配
```

**Bash 实现**（基于 Perl）：

```perl
BEGIN {
  state = "NORMAL"
  comment = ""
}

# 状态转换和注释提取
```

**PowerShell 实现**：

```powershell
$state = "NORMAL"
foreach ($line in $fileContent) {
  # 状态机逻辑
}
```

---

## 核心算法

### 注释匹配逻辑

1. **识别注释块**：
   - 函数声明上方的连续 `//` 行
   - 在空行或非注释行处停止

2. **提取首词**：
   - 删除前导 `//` 和空白
   - 获取首词（字母数字字符序列）
   - 忽略以 `:` 结尾的词（如 `TODO:`、`NOTE:`）

3. **提取函数名**：
   - 在注释块后找到 `func` 关键字
   - 处理方法接收器：`(receiver Type) functionName`
   - 支持嵌套括号

4. **对比**：
   - 区分大小写的字符串对比
   - 注释首词 vs 函数名
   - 记录匹配或不匹配以及行上下文

### 示例

```go
// Read reads data from the file
func Read(filename string) ([]byte, error) {
  // 实现
}
```

解析步骤：

1. 找到注释块：`["// Read reads data from the file"]`
2. 提取首词：`Read`
3. 找到函数：`func Read(filename string) ([]byte, error)`
4. 提取函数名：`Read`
5. 对比：`Read` == `Read` ✓ 匹配

---

## 实现差异

### 语言特性

| 特性           | Bash                 | PowerShell     |
| -------------- | -------------------- | -------------- |
| **关联数组**   | Bash 4.0+            | 原生字典       |
| **类型系统**   | 松散类型             | 类型感知       |
| **内置函数**   | 有限                 | 扩展库         |
| **错误处理**   | 退出码               | Try-catch 块   |
| **字符串处理** | `sed`、`awk`、`grep` | 原生字符串方法 |

### 代码组织

**Bash** (`go-doc-lint.sh`)：

```text
1. Shebang 和元数据
2. 全局变量
3. 实用函数
   - print_help()
   - print_version()
   - validate_args()
   - normalize_path()
4. 主处理函数
   - scan_directory()
   - scan_file()
5. Perl 脚本用于解析
6. 主执行块
```

**PowerShell** (`go-doc-lint.ps1`)：

```text
1. 脚本元数据
2. 参数定义
3. 辅助函数
   - Get-NormalizedPath
   - Invoke-FileScanning
   - New-Report
4. Process 块
   - 参数验证
   - 路径解析
   - 主执行
5. End 块
   - 输出生成
```

### 依赖管理

**Bash**：

- 需要：Bash 4.0+、Perl、awk、grep、sed
- 标准 Unix 工具普遍可用
- 脚本中的版本检查

**PowerShell**：

- 需要：PowerShell 5.0+
- Windows 10+ 包含
- 无外部依赖
- 类型安全执行

---

## 测试策略

### 测试覆盖（每个实现 28 个测试）

```text
核心功能（5 个测试）
├── 版本显示
├── 帮助文本
├── 基本扫描
├── 参数验证
└── 输出格式

输入验证（5 个测试）
├── 无效路径
├── 缺少参数
├── 冲突参数
├── 路径规范化
└── 权限处理

文件过滤（4 个测试）
├── 非测试文件（默认）
├── 测试文件（--test）
├── 所有文件（--all）
└── 排除（vendor、.git）

输出处理（5 个测试）
├── 屏幕输出
├── 文件输出
├── 目录输出
├── 时间戳生成
└── 报告格式

边界情况（4 个测试）
├── 空目录
├── 深层嵌套文件
├── 特殊字符
└── Unicode 处理

错误情况（4 个测试）
├── 不存在的文件
├── 权限被拒绝
├── 磁盘满
└── 无效 Go 语法
```

### 测试执行

**Bash 测试**：

```bash
bash test.sh
# 输出：28 个测试，全部通过
```

**PowerShell 测试**：

```powershell
.\test.ps1
# 输出：28 个测试，全部通过
```

### 测试结构

每个测试包括：

1. **设置**：创建测试固件
2. **执行**：使用特定参数运行工具
3. **验证**：检查输出是否与预期结果匹配
4. **清理**：删除临时文件
5. **报告**：显示通过/失败并加彩色

---

## 性能考量

### 基准测试（典型项目）

| 操作            | Bash      | PowerShell | 注释                      |
| --------------- | --------- | ---------- | ------------------------- |
| 扫描 100 个文件 | ~0.5s     | ~0.8s      | Bash 因外部工具更快       |
| 解析注释        | ~2s       | ~1.5s      | PowerShell 字符串操作更快 |
| 生成报告        | ~0.1s     | ~0.1s      | 文件 I/O 相似             |
| **总计**        | **~2.6s** | **~2.4s**  | 总体可比                  |

### 优化机会

**Bash**：

- 使用 GNU parallel 并行处理
- 缓存已编译的 Perl 脚本
- 减少子进程调用

**PowerShell**：

- 使用 `foreach -parallel`（v7+）
- 批量正则表达式编译
- 管道优化

### 当前性能

- I/O 密集型操作（非 CPU 限制）
- 适合 10,000+ 文件的项目
- 最小内存占用（典型 <50MB）
- 与文件数量线性扩展

---

## 扩展工具

### 添加新功能

#### 步骤 1：更新两个实现

**Bash** (`go-doc-lint.sh`)：

1. 在帮助文本中添加参数
2. 在参数部分添加参数解析
3. 实现功能逻辑
4. 添加到主执行块

**PowerShell** (`go-doc-lint.ps1`)：

1. 使用 `[Parameter()]` 添加参数定义
2. 添加参数验证
3. 实现功能逻辑
4. 更新 process 块

#### 步骤 2：添加测试

为以下情况创建测试：

- 正常情况
- 边界情况
- 错误条件
- 与其他功能的交互

**示例：添加 `--json` 输出标志**

```bash
# Bash 版本
case "$arg" in
  -j|--json)
    output_format="json"
    ;;
esac
```

```powershell
# PowerShell 版本
[Parameter(Mandatory=$false)]
[switch]
$Json
```

#### 步骤 3：更新文档

1. 添加到 README.md（参数部分）
2. 添加到 README_cn.md（同上中文版）
3. 添加示例到 BEST_PRACTICES.md
4. 更新 CHANGELOG.md 中的功能描述

### 代码风格指南

**Bash**：

- 使用有意义的变量名
- 对复杂逻辑进行注释
- 避免使用反引号进行命令替换（使用 `$()`）
- 引用所有变量引用

**PowerShell**：

- 使用正确的大小写（函数使用 PascalCase）
- 对输出使用 `Write-Host`（不是 `echo`）
- 使用 `ValidateScript` 验证参数
- 使用有意义的错误消息

---

## 故障排查常见问题

### Bash 版本

**问题**："Command not found: perl"

- **解决**：安装 Perl（在 Linux 上运行 `apt-get install perl`，macOS 中可用）

**问题**：脚本不可执行

- **解决**：运行 `chmod +x go-doc-lint.sh`

**问题**：Bash 版本错误

- **解决**：使用 `bash --version` 检查，确保 4.0+

### PowerShell 版本

**问题**："ExecutionPolicy"

- **解决**：运行 `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`

**问题**：模块找不到

- **解决**：确保运行 PowerShell 5.0+（`$PSVersionTable.PSVersion`）

---

## 设计决策

### 为什么在 Bash 中使用 Perl 进行注释解析？

- **强大的正则表达式**：Go 语法的复杂模式匹配
- **状态机**：易于实现解析逻辑
- **可移植**：在所有类 Unix 系统中都可用
- **高效**：快速文本处理

### 为什么不使用单一实现？

- **平台特性**：不同 shell 有不同的优势
- **用户期望**：Windows 用户偏好 PowerShell，Unix 用户偏好 Bash
- **原生集成**：与系统工具更好地集成
- **可维护性**：用各自的语言编写更清晰的代码

### 为什么没有 JSON 输出？

- **范围限制**：初始版本专注于文本报告
- **未来扩展**：可在 v1.1 中添加
- **当前用法**：屏幕和文件输出对大多数用户足够

---

## 未来架构增强

### 潜在改进

1. **配置文件支持**
   - `.go-doc-lint.yaml` 用于项目特定设置
   - 在实现之间共享配置

2. **插件系统**
   - 允许自定义检查超越注释匹配
   - 与语言无关的插件接口

3. **并行处理**
   - 大型项目的多线程扫描
   - 保持与单线程回退的兼容性

4. **增强的输出格式**
   - 用于工具集成的 JSON
   - IDE 插件用的 XML
   - 网页查看器用的 HTML

5. **IDE 集成**
   - VSCode 扩展
   - GoLand 插件
   - Vim/Neovim 集成

---

## 贡献于架构

在提议更改时：

1. **保持功能一致**：更新两个实现
2. **保留简洁**：避免过度工程化
3. **记录决策**：解释权衡
4. **充分测试**：为新代码路径添加测试
5. **更新指南**：保持本文档最新

---

**最后更新**：2026-02-01
**版本**：1.0.0
**维护者**：go-doc-lint 团队
