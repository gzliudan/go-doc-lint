# go-doc-lint 最佳实践指南

[English](BEST_PRACTICES.md) | 中文版

本指南为在您的 Go 项目和 CI/CD 流程中集成和使用 go-doc-lint 提供最佳实践。

## 目录

1. [项目组织](#项目组织)
2. [常见项目结构](#常见项目结构)
3. [前置提交钩子集成](#前置提交钩子集成)
4. [CI/CD 流程集成](#cicd-流程集成)
5. [性能优化](#性能优化)
6. [修复文档问题](#修复文档问题)
7. [常见陷阱](#常见陷阱)

---

## 项目组织

### 推荐的 Go 项目结构

为了获得最佳效果，请遵循 Go 约定来组织项目：

```text
myproject/
├── cmd/               # 命令行应用
│   └── myapp/
│       └── main.go
├── pkg/               # 公共库
│   ├── api/
│   │   ├── client.go
│   │   └── client_test.go
│   └── auth/
│       ├── token.go
│       └── token_test.go
├── internal/          # 私有包
│   └── config/
│       ├── config.go
│       └── config_test.go
├── test/              # 集成测试
│   └── integration_test.go
├── vendor/            # 第三方依赖（自动排除）
├── go.mod
└── go.sum
```

### 文件命名约定

**为了让 go-doc-lint 最有效地工作：**

- **测试文件**：必须以 `_test.go` 结尾
  - ✅ `client_test.go` - 正确
  - ❌ `client.test.go` - 不被识别为测试文件
  - ❌ `clienttest.go` - 不被识别为测试文件

- **文档文件**：不会被扫描（Go 仅扫描 `.go` 文件）
  - `README.md`、`doc.md` 等安全忽略

### 常见项目结构

根据仓库布局选择合适的扫描方式，以获得更准确的结果。

#### Monorepo

典型结构：

```text
repo/
├── services/
│   ├── user/
│   └── billing/
├── libs/
│   ├── auth/
│   └── common/
└── tools/
```

推荐扫描方式：

```bash
# 扫描所有服务
./go-doc-lint.sh ./services

# 扫描单个服务
./go-doc-lint.sh ./services/user

# 扫描共享库
./go-doc-lint.sh ./libs
```

#### 多模块（多个 go.mod）

典型结构：

```text
repo/
├── go.mod
├── api/
│   └── go.mod
└── tools/
  └── go.mod
```

推荐扫描方式：

```bash
# 分别扫描每个模块
./go-doc-lint.sh .
./go-doc-lint.sh ./api
./go-doc-lint.sh ./tools
```

#### 生成代码与 vendor

建议：

- 生成文件通常包含 `Code generated by` 标记。
- 建议仅扫描源码目录以减少噪音。
- vendor 目录会自动排除，但自定义布局时请验证。

```bash
# 聚焦源码目录
./go-doc-lint.sh ./cmd
./go-doc-lint.sh ./pkg
./go-doc-lint.sh ./internal
```

#### 含内部工具的工作区

典型结构：

```text
repo/
├── cmd/
├── internal/
└── tools/
  ├── generator/
  └── linting/
```

推荐扫描方式：

```bash
# 扫描主程序与内部包
./go-doc-lint.sh ./cmd
./go-doc-lint.sh ./internal

# 可选：扫描工具目录
./go-doc-lint.sh ./tools
```

---

## 前置提交钩子集成

### 选项 1：使用 Husky（适合基于 JavaScript 的项目）

如果您的项目有 `package.json`，可以使用 Husky：

```bash
npm install husky --save-dev
npx husky install
npx husky add .husky/pre-commit './go-doc-lint.sh'
```

### 选项 2：使用 Pre-commit 框架

在项目根目录创建 `.pre-commit-hooks.yaml`：

```yaml
repos:
  - repo: local
    hooks:
      - id: go-doc-lint
        name: go-doc-lint
        entry: bash go-doc-lint.sh
        language: script
        types: [go]
        stages: [commit]
```

安装钩子：

```bash
# 安装 pre-commit 框架
pip install pre-commit

# 安装钩子
pre-commit install

# （可选）在所有文件上运行
pre-commit run --all-files
```

### 选项 3：手动 Git 钩子

创建 `.git/hooks/pre-commit`：

```bash
#!/bin/bash
set -e

# 运行 go-doc-lint
if ! bash go-doc-lint.sh ./; then
    echo "文档检查失败。修复问题后重试。"
    exit 1
fi
```

使其可执行：

```bash
chmod +x .git/hooks/pre-commit
```

---

## CI/CD 流程集成

### GitHub Actions

创建 `.github/workflows/lint.yml`：

```yaml
name: 文档检查

on: [push, pull_request]

jobs:
  lint-bash:
    name: 检查 (Bash)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: 运行 go-doc-lint
        run: bash go-doc-lint.sh ./

  lint-powershell:
    name: 检查 (PowerShell)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: 运行 go-doc-lint
        run: powershell -File go-doc-lint.ps1 -InputPath "./"
```

### GitLab CI

创建 `.gitlab-ci.yml`：

```yaml
doc-lint:
  image: golang:latest
  script:
    - bash go-doc-lint.sh ./
  only:
    - merge_requests
    - main
```

### Jenkins

创建 `Jenkinsfile`：

```groovy
pipeline {
    agent any

    stages {
        stage('检查文档') {
            steps {
                script {
                    sh 'bash go-doc-lint.sh ./'
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'go-doc-lint-*.txt', allowEmptyArchive: true
        }
    }
}
```

---

## 性能优化

### 扫描性能特征

- **典型速度**：50-100 个 Go 文件/秒
- **内存使用**：典型项目 < 50MB
- **I/O 绑定**：性能取决于磁盘速度
- **线性扩展**：扫描时间与文件数线性相关

### 大型项目优化建议（>10,000 个文件）

1. **并行运行**：分割目录并并行扫描

   ```bash
   # 并行扫描不同的包
   bash go-doc-lint.sh ./pkg/auth/ &
   bash go-doc-lint.sh ./pkg/api/ &
   bash go-doc-lint.sh ./pkg/db/ &
   wait
   ```

2. **排除 vendor 目录**：已自动排除，但建议验证

   ```bash
   # 这比包含 vendor 更快
   bash go-doc-lint.sh ./pkg/ --all
   ```

3. **保存到文件**：处理结果更快

   ```bash
   bash go-doc-lint.sh ./ -o results.txt
   ```

4. **缓存结果**：在 CI 中，考虑在运行之间缓存

   ```yaml
   # GitHub Actions 示例
   - uses: actions/cache@v3
     with:
       path: go-doc-lint-*.txt
       key: doc-lint-${{ github.sha }}
   ```

---

## 修复文档问题

### 分步指南

1. **运行 linter 并保存输出**

   ```bash
   bash go-doc-lint.sh ./ -o issues.txt
   ```

2. **查看报告**

   ```text
   File: pkg/auth/token.go
   Comment First Word: read
   Function Name: ReadToken
   Comment Line: // read token from cache
   Function Declaration: func ReadToken(cache Cache) string {
   ```

3. **修复问题**

   ```go
   // 修复前
   // read token from cache
   func ReadToken(cache Cache) string {

   // 修复后
   // ReadToken 从缓存检索令牌
   func ReadToken(cache Cache) string {
   ```

4. **重新运行以验证**

   ```bash
   bash go-doc-lint.sh ./pkg/auth/token.go
   ```

### 批量修复提示

对于有许多问题的大型代码库：

1. **按目录分组** - 一次修复一个包
2. **使用 IDE 查找/替换** - VSCode、GoLand 可帮助修复模式
3. **脚本替换** - 使用 `sed` 或类似工具进行系统修复

```bash
# 示例：为 ReadXxx 函数替换注释中的 "read"
sed -i 's/\/\/ read /\/\/ Read /g' pkg/auth/*.go
```

---

## 常见陷阱

### ❌ 陷阱 1：大小写不匹配

```go
// read data from file
func ReadData() {}  // ❌ 首字不匹配（小写 vs PascalCase）

// ReadData reads data from file
func ReadData() {}  // ✅ 正确
```

**修复**：确保注释的首词与函数名完全匹配（区分大小写）。

### ❌ 陷阱 2：使用错误的标点

```go
// Read, data from file
func ReadData() {}  // ❌ 注释是 "Read,"，但函数是 "ReadData"

// ReadData reads data from file
func ReadData() {}  // ✅ 正确
```

**修复**：首词必须完全匹配，不带任何附加标点。

### ❌ 陷阱 3：注释距离太远

```go
// Helper function
func Helper() {}

// 这个注释不在函数上方
func AnotherFunc() {}  // ❌ 缺少文档

// AnotherFunc does something
func AnotherFunc() {}  // ✅ 正确
```

**修复**：文档注释必须紧邻函数上方。

### ❌ 陷阱 4：方法 vs 函数混淆

```go
// read from buffer
func (b Buffer) Read(p []byte) int {  // ✅ 这是 Buffer 类型的方法

// ReadFile reads content from file
func ReadFile(path string) []byte {}  // ✅ 这是包级函数
```

**两者都支持**：go-doc-lint 识别方法（带接收者）和包级函数。

### ❌ 陷阱 5：注释中提及方法接收者

```go
// (b Buffer) Read from buffer
func (b Buffer) Read(p []byte) int {}  // ❌ 不要在注释中提及接收者

// Read reads from the buffer
func (b Buffer) Read(p []byte) int {}  // ✅ 正确
```

**修复**：注释应仅提及方法名，不提及接收者。

### ✅ 特殊情况：TODO 注释

```go
// TODO: optimize this function
func OptimizeMe() {}  // ✅ 允许 - 以 ':' 结尾的词是例外
```

**特殊处理**：以 ':' 结尾的词（如 TODO:、FIXME:、NOTE:）自动从匹配中排除。

---

## 导出文档

### 确保公共 API 已记录

在 Go 中，文档注释对导出（公共）类型和函数至关重要：

```go
// ❌ 公共但未记录
func PublicAPI() {}

// ✅ 正确记录的公共 API
// PublicAPI 提供对核心功能的外部访问
func PublicAPI() {}
```

### 使用 godoc

修复文档后：

```bash
# 生成本地文档
godoc -http=:6060

# 访问 http://localhost:6060/pkg/github.com/yourname/myproject/
```

---

## 集成检查清单

- [ ] 代码按照 Go 约定组织
- [ ] 测试文件以 `_test.go` 结尾
- [ ] 所有导出函数都有文档注释
- [ ] 文档注释首词为函数名
- [ ] 前置提交钩子已安装且正常工作
- [ ] CI/CD 流程包含文档检查
- [ ] 团队成员了解文档要求
- [ ] 问题得到及时追踪和修复

---

## 其他资源

- [Go 代码审查注释 - Doc Comments](https://github.com/golang/go/wiki/CodeReviewComments#comment-sentences)
- [有效的 Go - 注释](https://golang.org/doc/effective_go#commentary)
- [godoc 文档](https://pkg.go.dev/golang.org/x/tools/cmd/godoc)

---

**最后更新**：2026-02-01
**版本**：1.0.0
